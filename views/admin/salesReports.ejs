<%- include('../layouts/admin/header') %>

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="text-primary">Sales Report</h2>
            <div class="export-buttons">
                <button class="btn btn-primary me-2" onclick="previewPDF()">
                    <i class="material-icons md-file_download"></i> Preview PDF
                </button>

                <button class="btn btn-primary me-2" onclick="exportToPDF()">
                    <i class="material-icons md-file_download"></i> Export PDF
                </button>
                <button class="btn btn-success" style="background-color: #800000; color: antiquewhite; border: #800000;" onclick="exportToExcel()">
                    <i class="material-icons md-file_download"></i> Export Excel
                </button>
            </div>
        </div>

        <div id="pdfPreviewModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">PDF Preview</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <canvas id="pdfCanvas"></canvas>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <select class="form-select w-auto" name="dateRange" id="dateRangeSelect" aria-label="Select Date Range">
                <option value="">Select Date Range</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        
            <form class="d-flex align-items-center gap-2">
                <label for="startDate" class="form-label me-2">Start Date:</label>
                <input type="date" id="startDate" name="startDate" class="form-control w-auto">
                <label for="endDate" class="form-label me-2">End Date:</label>
                <input type="date" id="endDate" name="endDate" class="form-control w-auto">
            </form>
        </div>

        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Sales</h6>
                        <h3 class="text-primary">₹<%= totalSales %></h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Orders</h6>
                        <h3 class="text-success">
                            <%= count %>
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Discount</h6>
                        <h3 class="text-warning">₹<%=totalDiscount %></h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card shadow-sm text-center">
                    <div class="card-body">
                        <h6 class="text-muted">Total Customers</h6>
                        <h3 class="text-info"><%= totalUsers %></h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Report Table -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle text-center" id="salesTable">
                <thead class="table-primary text-uppercase">
                    <tr>
                        <th>Sl No</th>
                        <th>User Name</th>
                        <th>Email</th>
                        <th>Products</th>
                        <th>Quantity</th>
                        <th>Date</th>
                        <th>product Price</th>
                        <th>Coupon Discount</th>
                        <th>Final Amount</th>
                        <th>Payment Method</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <% let k=1; %>
                        <% for (let i=orders.length - 1; i>= 0; i--) { %>
                            <tr>
                                <td>
                                    <%= k++ %>
                                </td>
                                <td data-customer-id="<%= orders[i].user._id %>">
                                    <%= orders[i].user.username %>
                                </td>

                                <td>
                                    <%= orders[i].user.email %>
                                </td>
                                <td>
                                    <ul>
                                        <% if (orders[i].items && orders[i].items.length > 0) { %>
                                            <% orders[i].items.forEach(item => { %>
                                                <li>
                                                    <%= item.productId ? item.productId.productName : 'Unknown Product' %>
                                                </li>
                                            <% }); %>
                                        <% } else { %>
                                            <li>No items</li>
                                        <% } %>
                                    </ul>
                                </td>
                                <td>
                                    <ul>
                                        <% orders[i].items.forEach(item=> { %>
                                            <li>
                                                <%= item.quantity %>
                                            </li>
                                        <% }) %>
                                    </ul>
                                </td>
                                <td>
                                    <%= orders[i].createdAt.toLocaleDateString() %>
                                </td>
                                <td>₹<%= Math.round(orders[i].totalPrice).toLocaleString() %></td>
                                <td>₹<%= Math.floor(orders[i].totalPrice - orders[i].finalAmount) %></td>
                                <td>₹<%= Math.round(orders[i].finalAmount).toLocaleString() %></td>
                                <td>
                                    <%= orders[i].paymentMethod %>
                                </td>
                                <td>
                                    <%= orders[i].status %>
                                </td>
                            </tr>
                            <% } %>
                </tbody>
            </table>
        </div>
        
    </div>
    
    <div class="pagination-area mt-15 mb-50">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <% if (currentPage > 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                <% } %>
    
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <% if (i === currentPage) { %>
                        <li class="page-item active">
                            <span class="page-link"><%= i %></span>
                        </li>
                    <% } else if (i <= 3 || i > totalPages - 2 || (i >= currentPage - 1 && i <= currentPage + 1)) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                        </li>
                    <% } else if (i === 4 && currentPage > 4) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                <% } %>
    
                <% if (currentPage < totalPages) { %>
                    <li class="page-item">
                        <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                <% } %>
            </ul>
        </nav>
    </div>

    <br>
    <br>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>

<script>
    const today = new Date().toISOString().split('T')[0];

    document.getElementById('startDate').setAttribute('max', today);
    document.getElementById('endDate').setAttribute('max', today);
</script>

<script>
    function exportToPDF() {
    window.location.href = '/admin/sales-report/pdf';
}
    function exportToExcel() {
        window.location.href = '/admin/sales-report/excel';
    }

    
    function initializeDateFilter() {
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const table = document.getElementById('salesTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');
        const dateRangeSelect = document.getElementById('dateRangeSelect');

    }

    document.addEventListener('DOMContentLoaded', initializeDateFilter);
</script>


    <%- include('../layouts/admin/footer') %>