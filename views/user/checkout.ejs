<%- include('../layouts/user/header') %>

<style>
    body {
        background-color: #f4f4f4;
        font-family: 'Arial', sans-serif;
    }

    .checkout-container {
        max-width: 800px;
        margin: 50px auto;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .section-title {
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 15px;
        margin-bottom: 25px;
        font-weight: 600;
    }

    .address-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .address-card:hover {
        border-color: #800000;
        box-shadow: 0 2px 8px #6f3535;
    }

    .address-card.selected {
        border-color: #800000;
        background-color: #f0f9f0;
    }

    .product-item {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #f0f0f0;
        padding: 15px 0;
    }

    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
    }

    .order-summary {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    .btn-place-order {
        background-color: #800000;
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        border-radius: 8px;
        font-weight: 600;
        transition: background-color 0.3s ease;
    }

    .btn-place-order:hover {
        background-color: #800000;
    }

    .payment-method {
        background-color: #f0f0f0;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        text-align: center;
    }
</style>

<main class="container">
    <div class="checkout-container">
        <div class="row">
            <!-- Address Selection -->
            <div class="col-md-6">
                <h4 class="section-title">Select Delivery Address</h4>
                <div id="address-container">
                    <% if (address.length > 0) { %>
                        <% address.forEach((addr, i) => { %>
                            <div class="address-card" onclick="selectAddress(this, '<%= addr._id %>')">
                                <input type="radio" name="selectedAddress" id="address-<%= i %>" 
                                    value="<%= JSON.stringify(addr) %>" class="d-none">
                                <h5><%= addr.addressType %></h5>
                                <p class="mb-1"><%= addr.name %></p>
                                <p class="mb-1"><%= addr.streetAddress %></p>
                                <p class="mb-1"><%= addr.city %>, <%= addr.state %> - <%= addr.pincode %></p>
                                <p><%= addr.phone %></p>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="alert alert-info">
                            No addresses available. <a href="/add-address">Add one now</a>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-md-6">
                <h4 class="section-title">Order Summary</h4>
                
                <!-- Products -->
                <div class="products-list">
                    <% if (cart && cart.items.length > 0) { %>
                        <% cart.items.forEach(item => { %>
                            <div class="product-item">
                                <img src="/uploads/re-image/<%= item.productId.productImage[0] %>" 
                                    alt="<%= item.productId.productName %>" class="product-image">
                                <div>
                                    <h5><%= item.productId.productName %></h5>
                                    <p>Quantity: <%= item.quantity %></p>
                                    <p class="text-success">₹<%= (item.productId.salePrice * item.quantity).toLocaleString() %></p>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>

                    <% if (product) { %>
                        <div class="product-item">
                            <img src="/uploads/re-image/<%= product.productImage[0] %>" 
                                alt="<%= product.productName %>" class="product-image">
                            <div>
                                <h5><%= product.productName %></h5>
                                <p>Quantity: 1</p>
                                <p class="text-success">₹<%= product.salePrice.toLocaleString() %></p>
                            </div>
                        </div>
                    <% } %>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total</span>
                        <span>₹<%= totalPrice.toLocaleString() %></span>
                    </div>
                    <div class="payment-method">
                        <strong>Payment Method</strong>
                        <p>Cash on Delivery (COD)</p>
                        <small class="text-muted">Pay when your order is delivered</small>
                    </div>
                </div>

                <!-- Order Form -->
                <form id="orderForm" onsubmit="return handleFormSubmission(event)">
                    <input type="hidden" name="cart" value='<%= JSON.stringify(cart ? cart.items : []) %>'>
                    <input type="hidden" name="totalPrice" value="<%= totalPrice %>">
                    <input type="hidden" name="payment_method" value="COD">
                    <input type="hidden" name="addressId" id="addressId">

                    <% if (product) { %>
                        <input type="hidden" name="singleProduct" value="<%= JSON.stringify(product) %>">
                    <% } %>

                    <button type="submit" class="btn-place-order mt-3" >Place Order</button>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
    function selectAddress(element, addressId) {
        document.querySelectorAll('.address-card').forEach(card => {
            card.classList.remove('selected');
        });
        element.classList.add('selected');
        document.getElementById('addressId').value = addressId;
        element.querySelector('input[type="radio"]').checked = true;
    }

    async function handleFormSubmission(event) {
        event.preventDefault();

        if (!validateAddress()) {
            return false;
        }

        const form = event.target;
        const formData = new FormData(form);

        try {
            Swal.fire({
                title: 'Processing Order',
                text: 'Please wait...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const codResponse = await fetch('/place-order-initial', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...Object.fromEntries(formData),
                    paymentMethod: 'COD',
                    paymentStatus: 'Pending'
                })
            });

            const result = await codResponse.json();
            if (!result.success) throw new Error(result.message || 'Failed to place COD order.');

            window.location.href = `/order-confirmation?id=${result.orderId}`;

        } catch (error) {
            console.error('Order processing error:', error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Failed to process your order. Please try again.',
                icon: 'error'
            });
        }
    }

    function validateAddress() {
        const addressId = document.getElementById('addressId').value;
        if (!addressId) {
            Swal.fire({
                title: 'Select Address',
                text: 'Please select a delivery address to continue',
                icon: 'warning'
            });
            return false;
        }
        return true;
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<%- include('../layouts/user/footer') %>